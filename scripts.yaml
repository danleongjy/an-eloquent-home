fan_set_state:
  alias: Fan Set State
  fields:
    target_fan:
      name: Target Fan
      description: The fan for which to set the state
      selector:
        select:
          options:
          - Parents' Room Fan
          - Elena's Room Fan
          - Eli's Room Fan
      required: true
      default: Living Room Fan
    target_fan_power:
      name: Target Fan Power
      description: Whether the fan is on or off
      selector:
        boolean:
      required: true
      default: true
    target_fan_speed:
      name: Target Fan Speed
      description: The speed of the fan
      selector:
        number:
          min: 0
          max: 100
          step: 16
          mode: slider
      required: false
      default: 33
  sequence:
  - service: remote.send_command
    target:
      entity_id: "{% set universal_remote = \n  { \"Elena's Room Fan\": \"remote.elis_room_universal_remote\",\n
        \   \"Eli's Room Fan\": \"remote.elis_room_universal_remote\",\n    \"Parents'
        Room Fan\": \"remote.parents_room_universal_remote\",\n  } %}\n{{ universal_remote[target_fan]
        }}\n"
    data:
      device: '{{ target_fan }}

        '
      command: "{% if target_fan_power == false %}\n  Off\n{% elif ((target_fan_speed
        | int) / 100 * 6) | round(0) == 0 %}\n  Off\n{% else %}\n  {{ ((target_fan_speed
        | int) / 100 * 6) | round(0) }}\n{% endif %}"
  mode: queued
  icon: mdi:speedometer
  max: 10
  max_exceeded: silent
fan_set_direction:
  alias: Fan Set Direction
  fields:
    target_fan:
      name: Target Fan
      description: The fan for which to set direction
      selector:
        select:
          options:
          - Parents' Room Fan
          - Elena's Room Fan
          - Eli's Room Fan
      required: true
      default: Living Room Fan
    direction:
      name: Direction
      description: The fan spin direction
      selector:
        select:
          options:
          - forward
          - reverse
      required: true
      default: forward
  variables:
    fan:
      Elena's Room Fan:
        entity_id: fan.elenas_room_fan
        remote: remote.elis_room_universal_remote
        direction: input_select.elenas_room_fan_direction
      Eli's Room Fan:
        entity_id: fan.elis_room_fan
        remote: remote.elis_room_universal_remote
        direction: input_select.elis_room_fan_direction
      Parents' Room Fan:
        entity_id: fan.parents_room_fan
        remote: remote.parents_room_universal_remote
        direction: input_select.parents_room_fan_direction
  sequence:
  - if:
    - condition: template
      value_template: '{{ states(fan[target_fan][''direction'']) != direction }}'
    then:
    - if:
      - condition: template
        value_template: '{{ states(fan[target_fan][''entity_id'']) == ''off'' }}'
      then:
      - service: fan.turn_on
        target:
          entity_id: '{{ fan[target_fan][''entity_id''] }}'
      - delay:
          hours: 0
          minutes: 0
          seconds: 3
          milliseconds: 0
    - service: remote.send_command
      target:
        entity_id: '{{ fan[target_fan][''remote''] }}'
      data:
        device: '{{ target_fan }}'
        command: Reverse
  - service: input_select.select_option
    target:
      entity_id: '{{ fan[target_fan][''direction''] }}'
    data:
      option: '{{ direction }}'
  mode: queued
  icon: mdi:rotate-3d-variant
  max: 10
  max_exceeded: silent
turn_off_all:
  sequence:
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id:
      - automation.playroom_motion_timeout
      - automation.yard_motion_timeout
      - automation.kitchen_motion_timeout
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: media_player.kitchen_speaker
        state: 'off'
    then:
    - service: media_player.media_stop
      data: {}
      target:
        entity_id: media_player.kitchen_speaker
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 300
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id:
      - automation.elenas_room_motion_timeout
      - automation.master_bathroom_motion_timeout
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 300
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id:
      - automation.elis_room_motion_timeout
      - automation.parents_room_motion_timeout
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 300
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id: automation.hallway_motion_timeout
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 100
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id: automation.junior_bathroom_motion_timeout
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 100
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id:
      - automation.study_room_motion_timeout
      - automation.powder_room_motion_timeout
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: media_player.study_room_speaker
        state: 'off'
    then:
    - service: media_player.media_stop
      data: {}
      target:
        entity_id: media_player.study_room_speaker
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 300
  - service: automation.trigger
    data:
      skip_condition: true
    target:
      entity_id:
      - automation.dining_room_motion_timeout
      - automation.living_room_motion_timeout
      - automation.dining_and_living_room_ac_motion_timeout
  - service: switch.turn_off
    data: {}
    target:
      entity_id: switch.water_heater
  mode: single
  alias: Turn Off All
  icon: mdi:home-export-outline
increment_alarm_day:
  alias: Increment Alarm Day
  fields:
    alarm_datetime:
      name: Alarm Datetime Helper
      description: A datetime helper containing the current datetime of the alarm
      required: true
      selector:
        entity:
          filter:
          - domain: input_datetime
    calendars:
      name: Work or School Day Calendars
      description: Calendars indicating work or school days.
      required: true
      selector:
        entity:
          multiple: true
          filter:
          - domain: calendar
  variables:
    off_time:
      events: []
  sequence:
  - service: calendar.get_events
    data:
      start_date_time: '{{ as_datetime(states(alarm_datetime)).replace(hour = 0, minute
        = 0) }}'
      end_date_time: '{{ as_datetime(states(alarm_datetime)).replace(hour = 0, minute
        = 0) + timedelta(days = 1) }}'
    target:
      entity_id: '{{ calendars }}'
    response_variable: work_school_day
    alias: List work/school days occurring on next alarm day
  - repeat:
      while:
      - or:
        - condition: template
          value_template: '{{ now().date() >= as_datetime(states(alarm_datetime)).date()
            }}'
          alias: Alarm day is not in the future
        - condition: template
          value_template: "{% set events = namespace(quantity = 0) %} {% for calendar
            in work_school_day %}\n  {% set events.quantity = events.quantity + work_school_day[calendar].events
            | length %}\n{% endfor %} {{ events.quantity == 0 }}\n"
          alias: Alarm day is not a work/school day
      sequence:
      - service: input_datetime.set_datetime
        data:
          date: '{{ as_datetime(states(alarm_datetime)).date() + timedelta(days =
            1) }}'
        target:
          entity_id: '{{ alarm_datetime }}'
        alias: Increment alarm by 1 day
      - service: calendar.get_events
        data:
          start_date_time: '{{ as_datetime(states(alarm_datetime)).replace(hour =
            0, minute = 0) }}'
          end_date_time: '{{ as_datetime(states(alarm_datetime)).replace(hour = 0,
            minute = 0) + timedelta(days = 1) }}'
        target:
          entity_id: '{{ calendars }}'
        response_variable: work_school_day
        alias: List work/school days occurring on next alarm day
    alias: Increment alarm by 1 day until it is a future day that is not an off day
  mode: parallel
  icon: mdi:alarm
nea_rain_radar_animation:
  alias: NEA Rain Radar Animation
  sequence:
  - repeat:
      for_each: "{% set start_time = (now() - timedelta(days = 1, minutes = 15)).replace(minute
        = (now() - timedelta(minutes = 15)).minute // 15 * 15) %} {% set missing_frames
        = namespace(frames = []) %} {% for i in range(97) %}\n  {% set current_frame
        = '/config/www/rain_radar/frames/dpsri_240km_' + (start_time + timedelta(minutes
        = 15 * i)).strftime('%Y%m%d%H%M') + '0000dBR.dpsri.png' %}\n  {% if current_frame
        not in state_attr('sensor.frames','file_list') %}\n    {% set missing_frames.frames
        = missing_frames.frames + [current_frame] %}\n  {% endif %}\n{% endfor %}
        {{ missing_frames.frames }}\n"
      sequence:
      - service: downloader.download_file
        data:
          overwrite: false
          url: https://www.nea.gov.sg/docs/default-source/rain-area-240km/{{ repeat.item.split('/')[-1]
            }}
          filename: '{{ repeat.item.split(''/'')[-1] }}'
      - delay: 2
  - service: shell_command.removeoldrainradar
    data: {}
  - service: shell_command.removeoldrainradaranimation
    data: {}
  - delay:
      hours: 0
      minutes: 0
      seconds: 2
      milliseconds: 0
  - service: pyscript.compile_rain_radar_animation
    data: {}
  mode: single
  icon: mdi:weather-cloudy
set_recommended_scene:
  alias: Set Recommended Scene
  sequence:
  - repeat:
      sequence:
        service: automation.trigger
        data:
          skip_condition: true
        target:
          entity_id: '{{ states.automation | selectattr(''entity_id'', ''search'',
            repeat.item + ''_motion'') | rejectattr(''entity_id'',''search'',''timeout'')
            | map(attribute = ''entity_id'') | list }}

            '
      for_each: '{{ room }}'
  mode: parallel
  icon: mdi:magic-staff
  max: 15
  fields:
    room:
      name: Room
      description: The room to set the recommended scene in
      selector:
        select:
          options:
          - label: Parents' Room
            value: parents_room
          - label: Master Bathroom
            value: master_bathroom
          - label: Kitchen
            value: kitchen
          - label: Study Room
            value: study_room
          - label: Living Room
            value: living_room
          - label: Dining Room
            value: dining_room
          - label: Playroom
            value: playroom
          - label: Yard
            value: yard
          - label: Hallway
            value: hallway
          - label: Powder Room
            value: powder_room
          - label: Junior Bathroom
            value: junior_bathroom
          - label: Eli's Room
            value: elis_room
          - label: Elena's Room
            value: elenas_room
          multiple: true
      required: true
recommended_light_level:
  alias: Recommended Light Level
  sequence:
  - variables:
      light_room: '{{ area_name(light) }}'
  - variables:
      dim_start: '{{ ''input_datetime.wind_down'' if light_room in wind_down_rooms
        else ''input_datetime.dim_hours_start'' }}'
      dim_end: '{{ ''input_datetime.sleep_hours_end'' if light_room in sleep_hours_end_rooms
        else ''input_datetime.dim_hours_end'' }}'
  - variables:
      light_brightness: "{% if states(dim_start) != states(dim_end) %}\n  {% if (now()
        > today_at(states(dim_start)) and now() <= today_at('23:59')) or (now() >=
        today_at('00:00') and now() <= today_at(states(dim_end))) %}\n    {{ states('input_number.night_light_brightness')
        | float }}\n  {% elif is_state('sun.sun','below_horizon') and state_attr('sun.sun','rising')
        %}\n    {{ states('input_number.morning_light_brightness') | float }}\n  {%
        else %}\n    100\n  {% endif %}\n{% else %}\n  100\n{% endif %}"
  - service: light.turn_on
    target:
      entity_id: '{{ light }}'
    data:
      brightness_pct: '{{ light_brightness }}'
  mode: parallel
  icon: mdi:lightbulb-on-70
  max: 15
  variables:
    wind_down_rooms:
    - Elena's Room
    - Eli's Room
    - Hallway
    - Master Bathroom
    - Parents' Room
    - Powder Room
    sleep_hours_end_rooms:
    - Elena's Room
    - Eli's Room
    - Hallway
    - Master Bathroom
    - Parents' Room
    - Powder Room
  fields:
    light:
      selector:
        entity:
          filter:
            domain: light
      name: Light
      description: The light on which to set the recommended level
      required: true
alarm_lights:
  alias: Alarm Lights
  sequence:
  - target:
      entity_id: '{{ [''light.'' + bedroom + ''_lights'',''light.'' + bedroom + ''_core_led_strips''
        ] }}'
    action: light.turn_off
  - delay: 5
  - target:
      entity_id: '{{ ''light.'' + bedroom + ''_core_display_backlight'' }}'
    data:
      brightness_pct: '{{ states(''input_number.morning_light_brightness'') | int
        if is_state(''sun.sun'',''below_horizon'') else 100 }}'
    action: light.turn_on
  - target:
      entity_id: '{{ ''light.'' + bedroom + ''_core_led_strips'' }}'
    data:
      rgb_color:
      - 229
      - 208
      - 164
      effect: Alarm
    action: light.turn_on
  - target:
      entity_id: '{{ ''select.'' + bedroom + ''_core_ringtone'' }}'
    data:
      option: '{{ ringtone }}'
    action: select.select_option
  - action: number.set_value
    target:
      entity_id: '{{ ''number.'' + bedroom + ''_core_speaker_volume'' }}'
    data:
      value: 10
  - target:
      entity_id: '{{ ''button.'' + bedroom + ''_core_play_ringtone'' }}'
    action: button.press
  - delay: 25
  - if:
    - condition: template
      value_template: '{{ is_state(''input_boolean.'' + bedroom + ''_next_alarm_dismissed'',
        ''off'') }}'
    then:
    - target:
        entity_id: '{{ ''select.'' + bedroom + ''_core_ringtone'' }}'
      data:
        option: Beep
      action: select.select_option
    - action: number.set_value
      target:
        entity_id: '{{ ''number.'' + bedroom + ''_core_speaker_volume'' }}'
      data:
        value: 10
    - repeat:
        sequence:
        - target:
            entity_id: '{{ ''light.'' + bedroom + ''_lights'' }}'
          action: light.toggle
        - target:
            entity_id: '{{ ''button.'' + bedroom + ''_core_play_ringtone'' }}'
          action: button.press
        - delay: 2
        while:
        - condition: template
          value_template: '{{ not ''on'' in states.binary_sensor | selectattr(''attributes.device_class'',
            ''defined'') | selectattr(''attributes.device_class'', ''eq'', ''door'')
            | selectattr(''entity_id'',''search'',bedroom) | map(attribute = ''state'')
            | list }}'
  - data:
      brightness_pct: "{% if is_state('sun.sun', 'below_horizon') %}\n  {{ states('input_number.morning_light_brightness')
        }}\n{% else %}\n  100\n{% endif %}\n"
    target:
      entity_id: '{{ ''light.'' + bedroom + ''_lights'' }}'
    action: light.turn_on
  - target:
      entity_id: '{{ ''light.'' + bedroom + ''_core_led_strips'' }}'
    action: light.turn_off
  mode: parallel
  icon: mdi:alarm
  max: 5
  fields:
    bedroom:
      selector:
        select:
          options:
          - label: Parents' Room
            value: parents_room
          - label: Eli's Room
            value: elis_room
          - label: Elena's Room
            value: elenas_room
      name: Bedroom
      description: The bedroom to run the alarm in
      required: true
    ringtone:
      selector:
        select:
          options:
          - Beep
          - Positive Beep
          - Negative Beep
          - Eli's Song
          - Pokemon
          - Under the Sea
          - Mario
      name: Ringtone
      description: Ringtone to play for the alarm
      required: true
      default: Eli's Song
git_push:
  alias: Git Push
  fields:
    commit_message:
      name: Commit Message
      description: Message to attach to the Git commit
      selector:
        text:
      required: true
  sequence:
  - service: watchman.report
    data:
      create_file: true
      send_notification: false
      parse_config: false
      chunk_size: false
  - service: readme.generate
    data: {}
  - delay: 5
  - service: shell_command.gitadd
    data: {}
  - service: shell_command.gitcommit
    data:
      commit_message: '{{ commit_message }}'
  - service: shell_command.gitpush
    data: {}
    enabled: true
  mode: single
  icon: mdi:git
automation_on_off_indicator_light:
  alias: Automation On/Off Indicator Light
  fields:
    flash_once:
      name: Flash Once for On
      description: Set to True to flash once for On, or False to flash twice for Off
      default: true
      selector:
        boolean:
      required: true
    indicator_light:
      name: Indicator Light
      description: The light to flash when the automation turns on or off
      selector:
        entity:
          filter:
          - domain:
            - light
      required: true
  sequence:
  - if:
    - condition: template
      value_template: '{{ flash_once }}'
    then:
    - if:
      - condition: template
        value_template: '{{ is_state(indicator_light, ''on'') }}'
      then:
      - data:
          flash: short
        target:
          entity_id: '{{ indicator_light }}'
        action: light.turn_on
      else:
      - data:
          flash: short
        target:
          entity_id: '{{ indicator_light }}'
        action: light.turn_on
      - delay: 1
      - target:
          entity_id: '{{ indicator_light }}'
        action: light.turn_off
    else:
    - if:
      - condition: template
        value_template: '{{ is_state(indicator_light, ''on'') }}'
      then:
      - repeat:
          count: 2
          sequence:
          - data:
              flash: short
            target:
              entity_id: '{{ indicator_light }}'
            action: light.turn_on
          - delay: 1
      else:
      - repeat:
          count: 2
          sequence:
          - data:
              flash: short
            target:
              entity_id: '{{ indicator_light }}'
            action: light.turn_on
          - delay: 1
      - target:
          entity_id: '{{ indicator_light }}'
        action: light.turn_off
  mode: parallel
  icon: mdi:lightbulb-on
stove_settings:
  alias: Stove Settings
  sequence:
  - if:
    - condition: template
      value_template: '{{ current_burner_power is defined }}'
    then:
    - service: select.select_option
      data:
        option: '{{ current_burner_power }}'
      target:
        entity_id: select.stove_current_burner_power
  - if:
    - condition: template
      value_template: '{{ current_burner_timer is defined }}'
    then:
    - service: number.set_value
      data:
        value: '{{ current_burner_timer }}'
      target:
        entity_id: number.stove_current_burner_timer
  mode: queued
  icon: mdi:stove
  fields:
    current_burner_power:
      selector:
        number:
          min: 0
          max: 9
          step: 1
      name: Current Burner Power
      description: Power level to set the current burner
      required: false
    current_burner_timer:
      selector:
        number:
          min: 0
          max: 99
          step: 1
      name: Current Burner Timer
      description: Number of minutes to turn on the current burner at current settings
      required: false
  max: 10
vacuum_selected_rooms:
  alias: Vacuum Selected Rooms
  sequence:
  - service: vacuum.send_command
    metadata: {}
    data:
      command: app_segment_clean
      params:
      - segments: '{{ rooms | map(''int'') | list }}'
    target:
      entity_id: vacuum.roborock_s7
  mode: single
  icon: mdi:home-plus-outline
  fields:
    rooms:
      selector:
        select:
          options:
          - label: Elena's Room
            value: '28'
          - label: Eli's Room
            value: '23'
          - label: Hallway
            value: '25'
          - label: Dining Room
            value: '24'
          - label: Playroom
            value: '19'
          - label: Parents' Room
            value: '20'
          - label: Study Room
            value: '22'
          - label: Kitchen
            value: '21'
          - label: Living Room
            value: '30'
          multiple: true
      name: Rooms
      description: The rooms to clean in the intended cleaning order
      required: true
      default:
      - '28'
      - '23'
      - '25'
      - '24'
      - '19'
      - '20'
      - '22'
      - '21'
      - '30'
botc_day_night_toggle:
  alias: BotC Day Night Toggle
  sequence:
  - repeat:
      sequence:
      - if:
        - or:
          - condition: template
            value_template: '{{ repeat.item.door == ''none'' }}'
          - condition: template
            value_template: '{{ is_state(repeat.item.door, ''on'') }}'
        then:
        - if:
          - condition: template
            value_template: '{{ is_state(repeat.item.light, ''on'') }}'
          then:
          - if:
            - condition: template
              value_template: '{{ set_day }}'
            then:
            - service: light.turn_on
              metadata: {}
              data:
                transition: 10
                brightness_pct: 100
              target:
                entity_id: '{{ repeat.item.light }}'
            - delay: 10
            else:
            - service: light.turn_on
              metadata: {}
              data:
                transition: 10
                brightness_pct: 10
              target:
                entity_id: '{{ repeat.item.light }}'
            - delay: 10
      for_each:
      - light: light.elenas_room_lights
        door: binary_sensor.elenas_room_door
      - light: light.elis_room_lights
        door: binary_sensor.elis_room_door
      - light: light.yard_light_entity
        door: none
      - light: light.playroom_lights
        door: none
      - light: light.hallway_lights
        door: none
      - light: light.dining_room_lights
        door: none
      - light: light.kitchen_lights
        door: none
      - light: light.parents_room_lights
        door: binary_sensor.parents_room_door
      - light: light.study_room_lights
        door: none
  description: Set lights to day or night mode for BotC games
  icon: mdi:theme-light-dark
  fields:
    set_day:
      selector:
        boolean: {}
      name: Set Day
      description: Turn on to set day mode or off to set night mode
      default: true
      required: true
  mode: parallel
  max: 5
doorbell:
  alias: Doorbell
  sequence:
  - variables:
      rooms:
        elis_room:
          door: binary_sensor.elis_room_door
          button: button.elis_room_core_ring_doorbell
        elenas_room:
          door: binary_sensor.elenas_room_door
          button: button.elenas_room_core_ring_doorbell
        parents_room:
          door: binary_sensor.parents_room_doors
          button: button.parents_room_core_ring_doorbell
  - parallel:
    - sequence:
      - action: media_player.volume_set
        metadata: {}
        data:
          volume_level: 0.5
        target:
          entity_id: media_player.all_speakers
      - delay: 1
      - target:
          entity_id: media_player.all_speakers
        data:
          media_content_id: "https://an-eloquent-home.duckdns.org/media/local/doorbells/{{
            ['JR DDG Final Osaka Loop', \n                                                               'JR
            DDG nDS e231 Door Chime',\n                                                               'JR
            Station Notification 2',\n                                                               'JR
            Sunny Spot V1',\n                                                               'JR
            Cosmos V1',\n                                                               'JR
            Susuki Heights V2'] | random }}.mp3\n"
          media_content_type: music
        action: media_player.play_media
      - repeat:
          for_each:
          - elis_room
          - elenas_room
          - parents_room
          sequence:
            if:
            - condition: template
              value_template: '{{ is_state(rooms[repeat.item][''door''], ''on'') }}'
            then:
            - target:
                entity_id: '{{ rooms[repeat.item][''button''] }}'
              action: button.press
      - target:
          entity_id:
          - button.kitchen_core_ring_doorbell
          - button.study_room_core_ring_doorbell
        data: {}
        action: button.press
    - sequence:
      - delay: 5
      - data:
          skip_condition: true
        target:
          entity_id: automation.main_door_camera_snapshots
        action: automation.trigger
      - delay: 2
      - metadata: {}
        data:
          message: Doorbell rung at {{ now().strftime('%H:%M') }}.
          title: Please Check the Door
          data:
            image: /media/local/main_door_camera/{{ states('input_text.newest_main_door_camera_snapshot_filename')
              }}
            clickAction: /lovelace/dining_room
        action: notify.mobile_app_pixel_4a
  description: Play doorbell tones and flash Room Core lights
  icon: mdi:bell-ring-outline
  mode: restart
batch_update_esphome_nodes:
  alias: Batch Update ESPHome Nodes
  sequence:
  - repeat:
      sequence:
      - service: update.install
        target:
          entity_id: '{{ repeat.item }}'
        continue_on_error: true
      - wait_for_trigger:
        - platform: state
          entity_id:
          - update.parents_room_core_firmware
          attribute: in_progress
          to: false
        timeout: 10
      - delay: 0.5
      for_each: '{{ states.update | selectattr(''attributes.title'', ''eq'', ''ESPHome'')
        | selectattr(''state'', ''eq'', ''on'') | map(attribute = ''entity_id'') |
        list }}

        '
  description: Update ESPHome nodes in sequence
  icon: mdi:update
fan_controller:
  alias: Fan Controller
  fields:
    fan:
      name: Fan
      description: The fan to control
      selector:
        entity:
          filter:
          - domain: fan
      required: true
    command:
      name: Command
      description: The command for the fan to execute
      selector:
        select:
          options:
          - label: Turn On
            value: fan_on
          - label: Turn Off
            value: fan_off
          - label: Speed Up
            value: fan_speed_up
          - label: Slow Down
            value: fan_slow_down
          - label: Reverse
            value: fan_reverse
          - label: Forward
            value: fan_forward
      required: true
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_on'' }}'
      sequence:
      - action: fan.turn_on
        target:
          entity_id: '{{ fan }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_off'' }}'
      sequence:
      - action: fan.turn_off
        target:
          entity_id: '{{ fan }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_speed_up'' }}'
      sequence:
      - action: fan.increase_speed
        target:
          entity_id: '{{ fan }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_slow_down'' }}'
      sequence:
      - if:
        - condition: template
          value_template: '{{ state_attr(fan, ''percentage'') | int(0) < 20 }}'
        then:
        - action: fan.turn_off
          target:
            entity_id: '{{ fan }}'
        else:
        - action: fan.decrease_speed
          target:
            entity_id: '{{ fan }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_reverse'' }}'
      sequence:
      - action: fan.set_direction
        data:
          direction: reverse
        target:
          entity_id: '{{ fan }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''fan_forward'' }}'
      sequence:
      - action: fan.set_direction
        data:
          direction: forward
        target:
          entity_id: '{{ fan }}'
  description: Set fan state with physical controls
  icon: mdi:fan
  mode: parallel
  max: 6
lights_controller:
  alias: Lights Controller
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ command == ''lights_on'' }}'
      sequence:
      - repeat:
          for_each: '{{ lights }}'
          sequence:
          - action: script.recommended_light_level
            data:
              light: '{{ repeat.item }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''lights_off'' }}'
      sequence:
      - action: light.turn_off
        target:
          entity_id: '{{ lights }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''lights_brighten'' }}'
      sequence:
      - action: light.turn_on
        data:
          brightness_step_pct: '{{ states(''input_number.light_brightness_change_step'')
            }}'
        target:
          entity_id: '{{ lights }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''lights_darken'' }}'
      sequence:
      - action: light.turn_on
        data:
          brightness_step_pct: -{{ states('input_number.light_brightness_change_step')
            }}
        target:
          entity_id: '{{ lights }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''set_recommended_room_scene'' }}'
      sequence:
      - action: script.set_recommended_scene
        data:
          room: "{% set turnoff_entities = namespace(areas = []) %} {% for light in
            lights %}\n  {% set turnoff_entities.areas = turnoff_entities.areas +
            [area_name(light).lower().replace(' ','_').replace(\"'\",'')] %}\n{% endfor
            %} {{ turnoff_entities.areas | unique | list }}\n"
    - conditions:
      - condition: template
        value_template: '{{ command == ''turn_off_room'' }}'
      sequence:
      - action: automation.trigger
        data:
          skip_condition: true
        target:
          entity_id: "{% set motion_timeout_automations = {'Yard': ['automation.yard_motion_timeout'],\n
            \                                   'Playroom': ['automation.playroom_motion_timeout'],\n
            \                                   'Junior Bathroom': ['automation.junior_bathroom_motion_timeout'],\n
            \                                   'Powder Room': ['automation.powder_room_motion_timeout'],\n
            \                                   \"Elena's Room\": ['automation.elenas_room_motion_timeout'],\n
            \                                   \"Eli's Room\": ['automation.elis_room_motion_timeout'],\n
            \                                   'Hallway': ['automation.hallway_motion_timeout'],\n
            \                                   'Dining Room': ['automation.dining_room_motion_timeout','automation.dining_and_living_room_ac_motion_timeout'],\n
            \                                   'Living Room': ['automation.living_room_motion_timeout','automation.dining_and_living_room_ac_motion_timeout'],\n
            \                                   'Study Room': ['automation.study_room_motion_timeout'],\n
            \                                   \"Parents' Room\": ['automation.parents_room_motion_timeout'],\n
            \                                   'Master Bathroom': ['automation.master_bathroom_motion_timeout'],\n
            \                                   'Kitchen': ['automation.kitchen_motion_timeout']}
            %}\n{% set turnoff_entities = namespace(areas = [], automations = [])
            %} {% for light in lights %}\n  {% set turnoff_entities.areas = turnoff_entities.areas
            + [area_name(light)] %}\n{% endfor %} {% for area in turnoff_entities.areas
            %}\n  {% set turnoff_entities.automations = turnoff_entities.automations
            + motion_timeout_automations[area] %}\n{% endfor %} {{ turnoff_entities.automations
            | unique | list }}\n"
  fields:
    lights:
      name: Lights
      description: The lights to control
      selector:
        entity:
          filter:
          - domain: light
          multiple: true
      required: true
    command:
      name: Command
      description: The command for the lights to execute
      selector:
        select:
          options:
          - label: Turn On
            value: lights_on
          - label: Turn Off
            value: lights_off
          - label: Brighten
            value: lights_brighten
          - label: Darken
            value: lights_darken
          - label: Set Recommended Room Scene
            value: set_recommended_room_scene
          - label: Turn Off Room
            value: turn_off_room
      required: true
  description: Set lights state with physical controls
  icon: mdi:lightbulb-group
  mode: parallel
  max: 12
ac_controller:
  alias: AC Controller
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ command == ''ac_on'' }}'
      sequence:
      - action: climate.turn_on
        target:
          entity_id: '{{ ac }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''ac_off'' }}'
      sequence:
      - action: climate.turn_off
        target:
          entity_id: '{{ ac }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''ac_warmer'' }}'
      sequence:
      - action: climate.set_temperature
        target:
          entity_id: '{{ ac }}'
        data:
          temperature: "{% if state_attr(ac, 'temperature') < 27 %}\n  {{ state_attr(ac,
            'temperature') + 1 }}\n{% else %}\n  27\n{% endif %}\n"
    - conditions:
      - condition: template
        value_template: '{{ command == ''ac_colder'' }}'
      sequence:
      - action: climate.set_temperature
        target:
          entity_id: '{{ ac }}'
        data:
          temperature: "{% if state_attr(ac, 'temperature') > 24 %}\n  {{ state_attr(ac,
            'temperature') - 1 }}\n{% else %}\n  24\n{% endif %}\n"
    - conditions:
      - condition: template
        value_template: '{{ command == ''cooling_auto_control'' }}'
      sequence:
      - action: automation.turn_on
        target:
          entity_id: "{% set cooling_automations = {'climate.elenas_room_ac': 'automation.elenas_room_fan_auto_control',\n
            \                             'climate.elis_room_ac': 'automation.elis_room_fan_auto_control',\n
            \                             'climate.dining_room_ac': 'automation.dining_room_fan_auto_control',\n
            \                             'climate.living_room_ac': 'automation.living_room_fan_auto_control',\n
            \                             'climate.parents_room_ac': 'automation.parents_room_fan_auto_control',\n
            \                             'climate.study_room_ac': 'automation.study_room_fan_auto_control'}
            %}\n{{ cooling_automations[ac] }}\n"
      - condition: or
        conditions:
        - condition: time
          before: input_datetime.sleep_hours_start
          after: input_datetime.sleep_hours_end
        - condition: template
          value_template: '{{ ac in [''climate.dining_room_ac'',''climate.living_room_ac'',''climate.study_room_ac'']
            }}'
      - action: script.automation_on_off_indicator_light
        data:
          flash_once: true
          indicator_light: "{% set indicator_lights = {'climate.elenas_room_ac': 'light.elenas_room_bulb_1_entity',\n
            \                             'climate.elis_room_ac': 'light.elis_room_bulb_3_entity',\n
            \                             'climate.dining_room_ac': 'light.dining_room_bulb_4_entity',\n
            \                             'climate.living_room_ac': 'light.living_room_bulb_2_entity',\n
            \                             'climate.parents_room_ac': 'light.parents_room_bulb_3_entity',\n
            \                             'climate.study_room_ac': 'light.study_room_bulb_4_entity'}
            %}\n{{ indicator_lights[ac] }}\n"
    - conditions:
      - condition: template
        value_template: '{{ command == ''cooling_manual_control'' }}'
      sequence:
      - action: automation.turn_off
        target:
          entity_id: "{% set cooling_automations = {'climate.elenas_room_ac': 'automation.elenas_room_fan_auto_control',\n
            \                             'climate.elis_room_ac': 'automation.elis_room_fan_auto_control',\n
            \                             'climate.dining_room_ac': 'automation.dining_room_fan_auto_control',\n
            \                             'climate.living_room_ac': 'automation.living_room_fan_auto_control',\n
            \                             'climate.parents_room_ac': 'automation.parents_room_fan_auto_control',\n
            \                             'climate.study_room_ac': 'automation.study_room_fan_auto_control'}
            %}\n{{ cooling_automations[ac] }}\n"
      - condition: or
        conditions:
        - condition: time
          before: input_datetime.sleep_hours_start
          after: input_datetime.sleep_hours_end
        - condition: template
          value_template: '{{ ac in [''climate.dining_room_ac'',''climate.living_room_ac'',''climate.study_room_ac'']
            }}'
      - action: script.automation_on_off_indicator_light
        data:
          indicator_light: "{% set indicator_lights = {'climate.elenas_room_ac': 'light.elenas_room_bulb_1_entity',\n
            \                             'climate.elis_room_ac': 'light.elis_room_bulb_3_entity',\n
            \                             'climate.dining_room_ac': 'light.dining_room_bulb_4_entity',\n
            \                             'climate.living_room_ac': 'light.living_room_bulb_2_entity',\n
            \                             'climate.parents_room_ac': 'light.parents_room_bulb_3_entity',\n
            \                             'climate.study_room_ac': 'light.study_room_bulb_4_entity'}
            %}\n{{ indicator_lights[ac] }}\n"
  fields:
    ac:
      selector:
        entity:
          filter:
          - domain: climate
      name: AC
      description: The AC to control
      required: true
    command:
      selector:
        select:
          options:
          - label: Turn On
            value: ac_on
          - label: Turn Off
            value: ac_off
          - label: Warmer
            value: ac_warmer
          - label: Colder
            value: ac_colder
          - label: Cooling Auto Control
            value: cooling_auto_control
          - label: Cooling Manual Control
            value: cooling_manual_control
      name: Command
      description: The command for the AC to execute
      required: true
  description: Set AC state with physical controls
  icon: mdi:snowflake
  mode: parallel
  max: 10
cover_controller:
  alias: Cover Controller
  variables:
    light:
      cover.dining_room_blinds: light.dining_room_bulb_1_entity
      cover.living_room_blinds: light.living_room_bulb_3_entity
      cover.study_room_blinds: light.study_room_bulb_3_entity
      cover.master_bathroom_blind: light.master_bathroom_pendant_light_entity
      cover.kitchen_blind: light.kitchen_ceiling_light_entity
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ command == ''cover_open'' }}'
      sequence:
      - if:
        - condition: template
          value_template: '{{ is_state(cover, ''closing'') }}'
        then:
        - target:
            entity_id: '{{ cover }}'
          action: cover.stop_cover
        else:
        - target:
            entity_id: '{{ cover }}'
          action: cover.open_cover
    - conditions:
      - condition: template
        value_template: '{{ command == ''cover_close'' }}'
      sequence:
      - if:
        - condition: template
          value_template: '{{ is_state(cover, ''opening'') }}'
        then:
        - target:
            entity_id: '{{ cover }}'
          action: cover.stop_cover
        else:
        - target:
            entity_id: '{{ cover }}'
          action: cover.close_cover
    - conditions:
      - condition: template
        value_template: '{{ command == ''cover_auto_control'' }}'
      sequence:
      - target:
          entity_id: "{% if cover == 'cover.master_bathroom_blind' %}\n  automation.master_bathroom_blind_auto_control\n{%
            elif cover == 'cover.kitchen_blind' %}\n  automation.kitchen_blind_auto_control\n{%
            else %}\n  automation.south_facing_blinds_auto_control\n{% endif %}\n"
        action: automation.turn_on
      - condition: or
        conditions:
        - condition: template
          value_template: '{{ cover in [''cover.dining_room_blinds'',''cover.living_room_blinds'',''cover.study_room_blinds'',''cover.kitchen_blind'']
            }}'
        - condition: time
          before: input_datetime.sleep_hours_start
          after: input_datetime.sleep_hours_end
      - data:
          indicator_light: '{{ light[cover] }}'
          flash_once: true
        action: script.automation_on_off_indicator_light
    - conditions:
      - condition: template
        value_template: '{{ command == ''cover_manual_control'' }}'
      sequence:
      - target:
          entity_id: "{% if cover == 'cover.master_bathroom_blind' %}\n  automation.master_bathroom_blind_auto_control\n{%
            elif cover == 'cover.kitchen_blind' %}\n  automation.kitchen_blind_auto_control\n{%
            else %}\n  automation.south_facing_blinds_auto_control\n{% endif %}\n"
        action: automation.turn_off
      - condition: or
        conditions:
        - condition: template
          value_template: '{{ cover in [''cover.dining_room_blinds'',''cover.living_room_blinds'',''cover.study_room_blinds'',''cover.kitchen_blind'']
            }}'
        - condition: time
          before: input_datetime.sleep_hours_start
          after: input_datetime.sleep_hours_end
      - data:
          indicator_light: '{{ light[cover] }}'
        action: script.automation_on_off_indicator_light
  fields:
    cover:
      name: Cover
      description: The cover to control
      selector:
        entity:
          filter:
          - domain: cover
      required: true
    command:
      name: Command
      description: The command for the cover to execute
      selector:
        select:
          options:
          - label: Open
            value: cover_open
          - label: Close
            value: cover_close
          - label: Auto Control
            value: cover_auto_control
          - label: Manual Control
            value: cover_manual_control
      required: true
  description: Set cover state with physical controls
  icon: mdi:blinds
  mode: parallel
  max: 8
parents_room_ac_set_state:
  alias: Parents' Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.parents_room_ac_switch
  description: Turn on or off the Parents' Room AC
  icon: mdi:head-snowflake
study_room_ac_set_state:
  alias: Study Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.study_room_ac_switch
  description: Turn on or off the Study Room AC
  icon: mdi:snowflake
living_room_ac_set_state:
  alias: Living Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.living_room_ac_switch
  description: Turn on or off the Living Room AC
  icon: mdi:snowflake
dining_room_ac_set_state:
  alias: Dining Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.dining_room_ac_switch
  description: Turn on or off the Dining Room AC
  icon: mdi:snowflake
elis_room_ac_set_state:
  alias: Eli's Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.elis_room_ac_switch
  description: Turn on or off Eli's Room AC
  icon: mdi:snowflake
elenas_room_ac_set_state:
  alias: Elena's Room AC Set State
  use_blueprint:
    path: danleongjy/ac_set_state.yaml
    input:
      air_conditioner: switch.elenas_room_ac_switch
  description: Turn on or off Elena's Room AC
  icon: mdi:snowflake
