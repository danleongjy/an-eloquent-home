- binary_sensor:
  - name: Next Alarm Imminent
    unique_id: binary_sensor.next_alarm_imminent
    state: "{{ not states('sensor.next_alarm_timings')[:4] == 'AAAA' }}"
    attributes:
      Daniel: "{{ states('input_datetime.daniels_next_alarm') }}"
      Grace: "{{ states('input_datetime.graces_next_alarm') }}"
      Eli: "{{ states('input_datetime.elis_next_alarm') }}"
      Elena: "{{ states('input_datetime.elenas_next_alarm') }}"
      parents_room_next_alarm_time: "{{ ([states('input_datetime.daniels_next_alarm') | as_datetime, states('input_datetime.graces_next_alarm') | as_datetime] | min).strftime('%H:%M') }}"
      elis_room_next_alarm_time: "{{ (states('input_datetime.elis_next_alarm') | as_datetime).strftime('%H:%M') }}"
      elenas_room_next_alarm_time: "{{ (states('input_datetime.elenas_next_alarm') | as_datetime).strftime('%H:%M') }}"

  - name: Yard Window
    unique_id: binary_sensor.yard_window
    device_class: window
    state: >
      {{ is_state('binary_sensor.yard_window_1', 'on') or 
         is_state('binary_sensor.yard_window_2','on') }}
    attributes:
      total_panes_open: "{{ is_state('binary_sensor.yard_window_1','on') + is_state('binary_sensor.yard_window_2','on') }}/2"
      total_panes: 2
      yard_window_1: "{{ states('binary_sensor.yard_window_1') }}"
      yard_window_2: "{{ states('binary_sensor.yard_window_2') }}"

  - name: Elena's Room Windows
    unique_id: binary_sensor.elenas_room_windows
    device_class: window
    state: >
      {{ is_state('binary_sensor.elenas_room_left_window', 'on') or 
         is_state('binary_sensor.elenas_room_right_window','on') }}
    attributes:
      total_panes_open: "{{ is_state('binary_sensor.elenas_room_left_window','on') + is_state('binary_sensor.elenas_room_right_window','on') }}/2"
      total_panes: 2
      elenas_room_left_window: "{{ states('binary_sensor.elenas_room_left_window') }}"
      elenas_room_right_window: "{{ states('binary_sensor.elenas_room_right_window') }}"

  - name: Dining Room Windows
    unique_id: binary_sensor.dining_room_windows
    device_class: window
    state: >
      {{ is_state('binary_sensor.dining_room_left_window', 'on') or 
         is_state('binary_sensor.dining_room_right_window','on') }}
    attributes:
      total_panes_open: "{{ is_state('binary_sensor.dining_room_left_window','on') + is_state('binary_sensor.dining_room_right_window','on') }}/2"
      total_panes: 2
      dining_room_left_window: "{{ states('binary_sensor.dining_room_left_window') }}"
      dining_room_right_window: "{{ states('binary_sensor.dining_room_right_window') }}"

  - name: Living Room Windows
    unique_id: binary_sensor.living_room_windows
    device_class: window
    state: >
      {{ is_state('binary_sensor.living_room_left_window', 'on') or 
         is_state('binary_sensor.living_room_right_window','on') }}
    attributes:
      total_panes_open: "{{ is_state('binary_sensor.living_room_left_window','on') + is_state('binary_sensor.living_room_right_window','on') }}/2"
      total_panes: 2
      living_room_left_window: "{{ states('binary_sensor.living_room_left_window') }}"
      living_room_right_window: "{{ states('binary_sensor.living_room_right_window') }}"

  - name: Study Room Windows
    unique_id: binary_sensor.study_room_windows
    device_class: window
    state: >
      {{ is_state('binary_sensor.study_room_left_window', 'on') or 
         is_state('binary_sensor.study_room_right_window','on') }}
    attributes:
      total_panes_open: "{{ is_state('binary_sensor.study_room_left_window','on') + is_state('binary_sensor.study_room_right_window','on') }}/2"
      total_panes: 2
      study_room_left_window: "{{ states('binary_sensor.study_room_left_window') }}"
      study_room_right_window: "{{ states('binary_sensor.study_room_right_window') }}"

  - name: Hallway Doors
    unique_id: binary_sensor.hallway_doors
    device_class: door
    state: >
      {{ is_state('binary_sensor.powder_room_door', 'on') or
        is_state('binary_sensor.junior_bathroom_door', 'on') or
        is_state('binary_sensor.elis_room_door', 'on') or
        is_state('binary_sensor.elenas_room_door', 'on')
      }}
    attributes:
      powder_room_door: "{{ states('binary_sensor.powder_room_door') }}"
      junior_bathroom_door: "{{ states('binary_sensor.junior_bathroom_door') }}"
      elis_room_door: "{{ states('binary_sensor.elis_room_door') }}"
      elenas_room_door: "{{ states('binary_sensor.elenas_room_door') }}"
      total_doors_open: "{{ is_state('binary_sensor.powder_room_door', 'on') + is_state('binary_sensor.junior_bathroom_door', 'on') + is_state('binary_sensor.elenas_room_door', 'on') + is_state('binary_sensor.elis_room_door', 'on') }}/4"
      total_doors: "4"

  - name: Parents' Room Doors
    unique_id: binary_sensor.parents_room_doors
    device_class: door
    state: >
      {{ is_state('binary_sensor.parents_room_door', 'on') or
        is_state('binary_sensor.master_bathroom_door', 'on')
      }}
    attributes:
      parents_room_door: "{{ states('binary_sensor.parents_room_door') }}"
      master_bathroom_door: "{{ states('binary_sensor.master_bathroom_door') }}"
      total_doors_open: "{{ is_state('binary_sensor.parents_room_door', 'on') + is_state('binary_sensor.master_bathroom_door', 'on') }}/2"
      total_doors: "2"

  - name: AC On With Doors Open
    unique_id: binary_sensor.ac_on_with_doors_open
    state: >
      {{ is_state('binary_sensor.ac_on_with_door_open_at_elenas_room', 'on') 
         or is_state('binary_sensor.ac_on_with_door_open_at_elis_room', 'on') 
         or is_state('binary_sensor.ac_on_with_door_open_at_powder_room', 'on')
         or is_state('binary_sensor.ac_on_with_door_open_at_junior_bathroom', 'on')
         or is_state('binary_sensor.ac_on_with_door_open_at_dining_room', 'on')
         or is_state('binary_sensor.ac_on_with_doors_open_at_parents_room', 'on') 
         or is_state('binary_sensor.ac_on_with_door_open_at_master_bathroom', 'on') 
         or is_state('binary_sensor.ac_on_with_windows_open_at_elis_room', 'on') 
         or is_state('binary_sensor.ac_on_with_windows_open_at_elenas_room', 'on') 
         or is_state('binary_sensor.ac_on_with_windows_open_at_study_room', 'on') 
         or is_state('binary_sensor.ac_on_with_windows_open_at_parents_room', 'on') 
         or is_state('binary_sensor.ac_on_with_window_open_at_yard', 'on') 
         or is_state('binary_sensor.ac_on_with_window_open_at_kitchen', 'on') }}
    attributes:
      elenas_room_door: "{{ states('binary_sensor.elenas_room_door') }}"
      elenas_room_left_window: "{{ states('binary_sensor.elenas_room_left_window') }}"
      elis_room_door: "{{ states('binary_sensor.elis_room_door') }}"
      elis_room_right_window: "{{ states('binary_sensor.elis_room_right_window') }}"
      powder_room_door: "{{ states('binary_sensor.powder_room_door') }}"
      junior_bathroom_door: "{{ states('binary_sensor.junior_bathroom_door') }}"
      main_door: "{{ states('binary_sensor.main_door') }}"
      yard_window: "{{ states('binary_sensor.yard_window') }}"
      parents_room_door: "{{ states('binary_sensor.parents_room_door') }}"
      parents_room_left_window: "{{ states('binary_sensor.parents_room_left_window') }}"
      master_bathroom_door: "{{ states('binary_sensor.master_bathroom_door') }}"
      kitchen_window: "{{ states('binary_sensor.kitchen_window') }}"
      elenas_room_ac: "{{ states('climate.elenas_room_ac') }}"
      elis_room_ac: "{{ states('climate.elis_room_ac') }}"
      dining_room_ac: "{{ states('climate.dining_room_ac') }}"
      living_room_ac: "{{ states('climate.living_room_ac') }}"
      study_room_ac: "{{ states('climate.study_room_ac') }}"
      study_room_left_window: "{{ states('binary_sensor.study_room_left_window') }}"
      parents_room_ac: "{{ states('climate.parents_room_ac') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.playroom_radar_motion
    - platform: state
      entity_id: binary_sensor.playroom_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.playroom_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Playroom Presence
      unique_id: binary_sensor.playroom_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.playroom_radar_occupancy', 'on') or is_state('binary_sensor.playroom_radar_motion', 'on') }}"
      attributes:
        playroom_radar_occupancy: "{{ states('binary_sensor.playroom_radar_occupancy') }}"
        playroom_radar_motion: "{{ states('binary_sensor.playroom_radar_motion') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.elenas_room_motion
    - platform: state
      entity_id: binary_sensor.elenas_room_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.elenas_room_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Elena's Room Presence
      unique_id: binary_sensor.elenas_room_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.elenas_room_radar_occupancy', 'on') or is_state('binary_sensor.elenas_room_motion', 'on') }}"
      attributes:
        elenas_room_radar_occupancy: "{{ states('binary_sensor.elenas_room_radar_occupancy') }}"
        elenas_room_motion: "{{ states('binary_sensor.elenas_room_motion') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.elis_room_motion
    - platform: state
      entity_id: binary_sensor.elis_room_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.elis_room_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Eli's Room Presence
      unique_id: binary_sensor.elis_room_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.elis_room_radar_occupancy', 'on') or is_state('binary_sensor.elis_room_motion', 'on') }}"
      attributes:
        elis_room_radar_occupancy: "{{ states('binary_sensor.elis_room_radar_occupancy') }}"
        elis_room_motion: "{{ states('binary_sensor.elis_room_motion') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.dining_room_motion
    - platform: state
      entity_id: binary_sensor.dining_room_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.dining_room_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Dining Room Presence
      unique_id: binary_sensor.dining_room_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.dining_room_radar_occupancy', 'on') or is_state('binary_sensor.dining_room_motion', 'on') }}"
      attributes:
        dining_room_radar_occupancy: "{{ states('binary_sensor.dining_room_radar_occupancy') }}"
        dining_room_motion: "{{ states('binary_sensor.dining_room_motion') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.living_room_radar_motion
    - platform: state
      entity_id: binary_sensor.living_room_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.living_room_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Living Room Presence
      unique_id: binary_sensor.living_room_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.living_room_radar_occupancy', 'on') or is_state('binary_sensor.living_room_radar_motion', 'on') }}"
      attributes:
        living_room_radar_occupancy: "{{ states('binary_sensor.living_room_radar_occupancy') }}"
        living_room_radar_motion: "{{ states('binary_sensor.living_room_radar_motion') }}"

- trigger:
    - platform: state
      entity_id: binary_sensor.parents_room_motion
    - platform: state
      entity_id: binary_sensor.parents_room_radar_occupancy
      from: 'off'
      to: 'on'
      for:
        seconds: "{{ states('input_number.radar_occupancy_on_delay') | int(10) }}"
    - platform: state
      entity_id: binary_sensor.parents_room_radar_occupancy
      from: 'on'
      to: 'off'
  binary_sensor:
    - name: Parents' Room Presence
      unique_id: binary_sensor.parents_room_presence
      device_class: occupancy
      state: "{{ is_state('binary_sensor.parents_room_radar_occupancy', 'on') or is_state('binary_sensor.parents_room_motion', 'on') }}"
      attributes:
        parents_room_radar_occupancy: "{{ states('binary_sensor.parents_room_radar_occupancy') }}"
        parents_room_motion: "{{ states('binary_sensor.parents_room_motion') }}"

- trigger:
  - platform: state
    entity_id: binary_sensor.junior_bathroom_motion
    not_from:
      - unknown
      - unavailable
    not_to:
      - unknown
      - unavailable
  - platform: state
    entity_id: binary_sensor.junior_shower_motion
    not_from:
      - unknown
      - unavailable
    not_to:
      - unknown
      - unavailable
    for:
      minutes: 1
  binary_sensor:
    - name: Junior Bathroom Motion Sensors
      unique_id: binary_sensor.junior_bathroom_motion_sensors
      state: "{{ is_state('binary_sensor.junior_bathroom_motion','on') or is_state('binary_sensor.junior_shower_motion','on') }}"
      device_class: motion
      attributes:
        junior_bathroom_motion: "{{ states('binary_sensor.junior_bathroom_motion') }}"
        junior_shower_motion: "{{ states('binary_sensor.junior_shower_motion') }}"

- trigger:
  - platform: state
    entity_id: sensor.valetudo_hestia_battery_level
    not_from:
      - unavailable
      - unknown
    not_to:
      - unavailable
      - unknown
  binary_sensor:
    - name: Vacuum Battery Charging
      unique_id: binary_sensor.vacuum_battery_charging
      state: "{{ trigger.from_state.state | float(0) < trigger.to_state.state | float(0) }}"
      availability: "{{ not states('sensor.valetudo_hestia_battery_level') in ['unavailable','unknown'] }}"